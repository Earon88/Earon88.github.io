<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Blue Alert Chile - Mapa con GeoJSON</title>
  <link rel="icon" type="image/png" href="Imagenes/Favicon.png">
  <link rel="stylesheet" href="dist/output.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body class="bg-lightBg">
  <!-- Skip to Main Content Link -->
  <a href="BA2.html" class="absolute left-0 -top-10 bg-primary text-white px-4 py-2 rounded-br-md font-bold focus:top-0 transition-all z-50">
     Saltar al contenido principal
  </a>

  <!-- Header -->
  <header class="sticky top-0 z-40 h-24 bg-gradient-to-r from-[var(--primary-color)] to-[var(--secondary-color)] shadow-lg">
    <div class="flex flex-wrap items-center justify-evenly px-4 py-2">
      <div class="max-w-lg mx-auto">
        <a href="BA2.html">
          <img src="Imagenes/Logo_Blue_Alert.png" alt="Logo Blue Alert Chile" class="w-full h-auto hover:scale-110 transition-transform duration-1000">
        </a>
      </div>
      <nav class="flex flex-wrap justify-center gap-2 md:gap-4">
        <a href="BA2.html" class="text-white font-medium px-4 py-2 rounded-lg hover:bg-white/20 transition-all flex items-center">
          <i class="fas fa-home mr-2"></i> Inicio
        </a>
         <!--
        <a href="MapaBA.html" class="text-white font-medium px-4 py-2 rounded-lg hover:bg-white/20 transition-all flex items-center">
          <i class="fas fa-map-marked-alt mr-2"></i> Mapa Interactivo
        </a>
        -->
        <a href="#" class="text-white font-medium px-4 py-2 rounded-lg hover:bg-white/20 transition-all flex items-center">
          <i class="fas fa-newspaper mr-2"></i> Noticias
        </a>
        <a href="#" class="text-white font-medium px-4 py-2 rounded-lg hover:bg-white/20 transition-all flex items-center">
          <i class="fas fa-envelope mr-2"></i> Contacto
        </a>
      </nav>
    </div>
  </header>

  
  <!--map-->
  <main id="main-content" class="relative"> 
    <div id="map" class="absolute inset-0"></div>
    
    <!-- Control deslizante para trimestres con botón de reproducción -->
    <div class="absolute bottom-5 left-5 z-[1000] bg-white/90 p-4 rounded-lg shadow-md min-w-[300px]">
      <div class="flex justify-between items-center mb-3">
        <h3 class="m-0 text-base text-gray-800">Selecciona el trimestre</h3>
        <div class="flex items-center space-x-2">
          <!-- Botón de reproducción/pausa -->
          <button id="play-btn" class="bg-primary text-white p-2 rounded-full hover:bg-secondary transition-colors flex items-center justify-center w-10 h-10">
            <i class="fas fa-play text-xs ml-1"></i>
          </button>
          <!-- Selector de velocidad -->
          <select id="speed-select" class="text-xs p-1 border border-gray-300 rounded bg-white">
            <option value="1000">1x</option>
            <option value="500">2x</option>
            <option value="250">4x</option>
          </select>
        </div>
      </div>
      <input type="range" id="yearqtr_slider" min="0" value="0" step="1" class="w-full my-2">
      <div id="slider-value" class="font-bold text-secondary">Trimestre: </div>
    </div>
    
    <!-- Control de capas base - Ahora desplegable -->
    <div class="absolute top-24 right-3 z-40">
      <!-- Botón para desplegar/contraer -->
      <button id="layer-toggle" class="bg-white/90 text-gray-800 p-2 rounded-lg shadow-md flex items-center gap-2 hover:bg-gray-100 transition-colors">
        <i class="fas fa-layer-group"></i>
        <span>Capas</span>
        <i class="fas fa-chevron-down text-xs transition-transform" id="layer-chevron"></i>
      </button>
      
      <!-- Panel de capas (inicialmente oculto) -->
      <div id="layer-panel" class="bg-white/90 p-3 rounded-lg shadow-md mt-2 hidden w-48">
        <h4 class="m-0 mb-2 text-sm text-gray-800 font-semibold">Tipo de Mapa</h4>
        <button id="streets-btn" class="w-full text-left px-3 py-2 mb-1 rounded bg-gray-100 hover:bg-gray-200 transition-colors active:bg-primary active:text-white">
          Calles
        </button>
        <button id="satellite-btn" class="w-full text-left px-3 py-2 rounded bg-gray-100 hover:bg-gray-200 transition-colors">
          Satélite
        </button>
        
        <h4 class="m-0 my-2 text-sm text-gray-800 font-semibold pt-2 border-t border-gray-200">Capa de Datos</h4>
        <button id="canopy-btn" class="w-full text-left px-3 py-2 rounded bg-gray-100 hover:bg-gray-200 transition-colors active:bg-primary active:text-white">
          Dosel flotante
        </button>
      </div>
    </div>
    
    <!-- Botón para mostrar/ocultar filtros -->
    <button id="filter-toggle" class="absolute top-60 right-3 z-[1000] bg-primary text-white border-none rounded-full w-12 h-12 flex items-center justify-center cursor-pointer shadow-md">
      <i class="fas fa-filter"></i>
    </button>
    
    <!-- Panel de filtros -->
    <div id="filter-panel" class="absolute top-60 right-3 z-[1000] bg-white/95 p-5 rounded-lg shadow-md w-80 max-h-[80vh] overflow-y-auto hidden">
      <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-200">
        <h2 class="m-0 text-lg text-secondary font-semibold">Filtros</h2>
        <button class="close-btn bg-none border-none cursor-pointer text-xl text-gray-500 hover:text-gray-800 w-7 h-7 flex items-center justify-center rounded transition-colors" id="close-filters">
          &times;
        </button>
      </div>
      <p class="mb-5 text-gray-600">Explora el área y cobertura de sistemas ecológicos a través del tiempo.</p>
      
      <div class="mb-5">
        <label class="block mb-2 font-semibold text-gray-700">Período</label>
        <div class="flex items-center gap-3">
          <div class="flex-1">
            <label class="block mb-1 text-sm text-gray-700">Año de inicio</label>
            <select id="start-year" class="w-full p-2 border border-gray-300 rounded bg-white">
              <option value="2018">2018</option>
              <option value="2019">2019</option>
              <option value="2020">2020</option>
              <option value="2021">2021</option>
              <option value="2022">2022</option>
              <option value="2023">2023</option>
              <option value="2024">2024</option>
            </select>
          </div>
          <span class="text-gray-500 mt-5">a</span>
          <div class="flex-1">
            <label class="block mb-1 text-sm text-gray-700">Año de fin</label>
            <select id="end-year" class="w-full p-2 border border-gray-300 rounded bg-white">
              <option value="2018">2018</option>
              <option value="2019">2019</option>
              <option value="2020">2020</option>
              <option value="2021">2021</option>
              <option value="2022">2022</option>
              <option value="2023" selected>2023</option>
              <option value="2024">2024</option>
            </select>
          </div>
        </div>
      </div>
      
      <div class="mb-5">
        <label class="block mb-2 font-semibold text-gray-700">Variable de Tiempo</label>
        <div class="time-variable mb-2">
          <select id="time-variable" class="w-full p-2 border border-gray-300 rounded bg-white">
            <option value="annual" selected>Año calendario (Todos los trimestres)</option>
            <option value="q1">Primer trimestre</option>
            <option value="q2">Segundo trimestre</option>
            <option value="q3">Tercer trimestre</option>
            <option value="q4">Cuarto trimestre</option>
          </select>
        </div>
        <button class="info-btn bg-none border-none text-accent cursor-pointer text-sm mt-2 flex items-center gap-1 p-1 hover:text-secondary transition-colors">
          <!-- Icono de información simplificado -->
          <svg viewBox="0 0 24 24" width="16" height="16" class="fill-current">
            <circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="2"/>
            <line x1="12" y1="8" x2="12" y2="16" stroke="currentColor" stroke-width="2"/>
            <line x1="12" y1="16" x2="12" y2="19" stroke="currentColor" stroke-width="2"/>
          </svg>
          Más información sobre Variable de Tiempo
        </button>
      </div>
    </div>
  </main>

  <!-- Modal de Bienvenida - Versión mejorada -->
  <div id="welcome-modal" class="fixed inset-0 z-[1000] flex items-center justify-center bg-black/70 fade-in">
    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full mx-4 slide-in">
      <div class="md:flex">
        <!-- Panel lateral con imagen -->
        <div class="md:w-2/5 bg-gradient-to-b from-secondary to-accent p-8 text-white flex flex-col justify-center">
          <div class="text-center">
            <img src="Imagenes/Favicon.png" alt="Favicon Blue Alert" class="w-16 h-16 mx-auto mb-4"> 
            <h2 class="text-2xl font-bold mb-4">Blue Alert Chile</h2>
            <p class="opacity-90">Monitoreo de condiciones marinas</p>
          </div>
          <div class="mt-8 text-sm opacity-80">
            <p class="flex items-center mb-2"><i class="fas fa-check-circle mr-2"></i> Datos en tiempo real</p>
            <p class="flex items-center mb-2"><i class="fas fa-check-circle mr-2"></i> Alertas tempranas</p>
            <p class="flex items-center"><i class="fas fa-check-circle mr-2"></i> Información precisa</p>
          </div>
        </div>
        
        <!-- Contenido principal -->
        <div class="md:w-3/5 p-8">
          <div class="flex justify-between items-center mb-4">
            <h1 class="text-2xl font-bold text-gray-800">Bienvenido a Blue Alert Chile</h1>
            <button id="close-modal" class="text-gray-400 hover:text-gray-600">
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>
          
          <p class="text-gray-600 mb-4">Explora nuestras funcionalidades:</p>
          
          <ul class="space-y-3 mb-6">
            <li class="flex">
              <span class="bg-blue-100 text-blue-600 rounded-full h-6 w-6 flex items-center justify-center mr-3 flex-shrink-0">
                <i class="fas fa-map-marked-alt text-xs"></i>
              </span>
              <span class="text-gray-600">Visualización de datos geoespaciales en tiempo real.</span>
            </li>
            <li class="flex">
              <span class="bg-green-100 text-green-600 rounded-full h-6 w-6 flex items-center justify-center mr-3 flex-shrink-0">
                <i class="fas fa-bell text-xs"></i>
              </span>
              <span class="text-gray-600">Sistema de alertas tempranas para condiciones marinas.</span>
            </li>
            <li class="flex">
              <span class="bg-purple-100 text-purple-600 rounded-full h-6 w-6 flex items-center justify-center mr-3 flex-shrink-0">
                <i class="fas fa-download text-xs"></i>
              </span>
              <span class="text-gray-600">Descarga de informes y datos históricos.</span>
            </li>
          </ul>
          
            <div class="flex space-between md:flex-row items-center justify-between mt-8 pt-6 border-t border-gray-200">
              <!-- Interruptor con leyenda debajo -->
              <div class="flex flex-col items-center">
                <label class="flex flex-col items-center cursor-pointer">
                  <div class="relative mb-2">
                    <input type="checkbox" id="welcome-show-at-startup" class="sr-only" checked>
                    <div class="block bg-gray-300 w-10 h-6 rounded-full toggle-bg"></div>
                    <div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition toggle-dot"></div>
                  </div>
                  <span class="text-gray-700 text-sm md:text-base">Mostrar al iniciar</span>
                </label>
              </div>
              
              <!-- Botón Entendido -->
              <button id="accept-modal" class="bg-accent hover:bg-teal-700 text-white px-5 py-2 rounded-lg transition duration-200 flex items-center">
                <i class="fas fa-check mr-2"></i> Entendido
              </button>
            </div>
        </div>
      </div>
    </div>
  </div>

  <div class="flex items-center justify-center gap-4 my-8 text-white">
    <p class="text-sm text-white">Síguenos en redes sociales:</p>
    <a href="https://www.instagram.com/blue_alert/" target="_blank" 
       class="inline-flex items-center gap-2 px-4 py-1 bg-primary hover:bg-secondary rounded-full shadow-md transition-transform hover:-translate-y-1">
      <img src="https://cdn-icons-png.flaticon.com/512/2111/2111463.png" alt="Instagram" class="w-4 h-4">
      @blue_alert
    </a>
  </div>

  <!-- Footer -->
  <footer class="bg-secondary text-white text-center py-6 mt-8">
    <div class="mb-2">
      Contacto: 
      <a href="mailto:edguajardo@bluealertchile.com" class="text-accent font-medium hover:underline">edguajardo@bluealertchile.com</a>
    </div>
    <div class="text-sm opacity-80">
      &copy; 2023 Blue Alert Chile. Todos los derechos reservados.
      <p class="mt-1 italic">"No compitas, haz cumpitas"</p>
    </div>
  </footer>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  
  <script>
    // Crear mapa centrado
    var map = L.map('map').setView([ -41.45, -72.66 ], 6); // Santiago, Chile

    // Definir capas base
    var satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
      maxZoom: 19
    });

    var streetsLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      maxZoom: 19
    });

    // Añadir capa de calles por defecto
    streetsLayer.addTo(map);
    document.getElementById('streets-btn').classList.add('active');

    // Variables para almacenar los datos del GeoJSON
    let geojsonData = null;
    let filteredLayer = null;
    let canopyLayerVisible = true;
    let playbackInterval = null;
    let isPlaying = false;
    let yearqtrs = [];

    // Cargar GeoJSON
    fetch('MP_data.geojson')
      .then(response => response.json())
      .then(data => {
        geojsonData = data;
        
        // Obtener valores únicos de trimestre (yearqtr) del GeoJSON
        yearqtrs = [...new Set(data.features.map(f => f.properties.yearqtr))].sort();
        const slider = document.getElementById('yearqtr_slider');
        const sliderValue = document.getElementById('slider-value');
        
        // Configurar el slider
        slider.setAttribute('min', 0);
        slider.setAttribute('max', yearqtrs.length - 1);
        slider.value = yearqtrs.length - 1; // Última posición
    
         const lastIndex = yearqtrs.length - 1;
         sliderValue.textContent = `Trimestre: ${yearqtrs[lastIndex]}`;
           updateMap(yearqtrs[lastIndex]); // Mostrar último trimestre
        
        // Mostrar el primer trimestre por defecto|
        updateMap(yearqtrs[0]);
        
        // Event listener para el slider
        slider.addEventListener('input', function() {
          const index = parseInt(this.value);
          const selectedYearQtr = yearqtrs[index];
          sliderValue.textContent = `Trimestre: ${selectedYearQtr}`;
          
          // Actualizar el mapa solo si la capa de dosel está visible
          if (canopyLayerVisible) {
            updateMap(selectedYearQtr);
          }
        });
      })
      .catch(error => console.error('Error loading GeoJSON:', error));

    // Función para cambiar entre capas base
    function changeBaseLayer(layerType) {
      if (layerType === 'satellite') {
        map.removeLayer(streetsLayer);
        satelliteLayer.addTo(map);
        document.getElementById('satellite-btn').classList.add('active');
        document.getElementById('streets-btn').classList.remove('active');
      } else {
        map.removeLayer(satelliteLayer);
        streetsLayer.addTo(map);
        document.getElementById('streets-btn').classList.add('active');
        document.getElementById('satellite-btn').classList.remove('active');
      }
    }

    // Función para mostrar/ocultar la capa de dosel flotante
    function toggleCanopyLayer() {
      canopyLayerVisible = !canopyLayerVisible;
      const canopyBtn = document.getElementById('canopy-btn');
      
      if (canopyLayerVisible) {
        // Mostrar la capa
        const slider = document.getElementById('yearqtr_slider');
        const index = parseInt(slider.value);
        updateMap(yearqtrs[index]);
        canopyBtn.classList.add('active');
      } else {
        // Ocultar la capa
        if (filteredLayer) {
          map.removeLayer(filteredLayer);
          filteredLayer = null;
        }
        canopyBtn.classList.remove('active');
      }
    }

    // Función para reproducir/pausar la animación de trimestres
    function togglePlayback() {
      const playBtn = document.getElementById('play-btn');
      const slider = document.getElementById('yearqtr_slider');
      const speedSelect = document.getElementById('speed-select');
      
      if (isPlaying) {
        // Pausar la reproducción
        clearInterval(playbackInterval);
        playBtn.innerHTML = '<i class="fas fa-play text-xs ml-1"></i>';
        isPlaying = false;
      } else {
        // Iniciar la reproducción
        const speed = parseInt(speedSelect.value);
        playbackInterval = setInterval(() => {
          let currentValue = parseInt(slider.value);
          if (currentValue >= yearqtrs.length - 1) {
            currentValue = 0; // Reiniciar al llegar al final
          } else {
            currentValue++;
          }
          slider.value = currentValue;
          slider.dispatchEvent(new Event('input'));
        }, speed);
        
        playBtn.innerHTML = '<i class="fas fa-pause text-xs"></i>';
        isPlaying = true;
      }
    }

    // Event listeners para los botones de cambio de capa
    document.getElementById('satellite-btn').addEventListener('click', function() {
      changeBaseLayer('satellite');
    });

    document.getElementById('streets-btn').addEventListener('click', function() {
      changeBaseLayer('streets');
    });

    // Event listener para el botón de dosel flotante
    document.getElementById('canopy-btn').addEventListener('click', function() {
      toggleCanopyLayer();
    });

    // Event listener para el botón de reproducción
    document.getElementById('play-btn').addEventListener('click', function() {
      togglePlayback();
    });

    // Event listener para cambio de velocidad
    document.getElementById('speed-select').addEventListener('change', function() {
      if (isPlaying) {
        // Reiniciar la reproducción con la nueva velocidad
        clearInterval(playbackInterval);
        togglePlayback(); // Esto lo pausará
        togglePlayback(); // Esto lo reiniciará con la nueva velocidad
      }
    });

    // Función para mostrar/ocultar el panel de capas
    document.getElementById('layer-toggle').addEventListener('click', function() {
      const layerPanel = document.getElementById('layer-panel');
      const chevron = document.getElementById('layer-chevron');
      
      if (layerPanel.classList.contains('hidden')) {
        layerPanel.classList.remove('hidden');
        chevron.classList.remove('fa-chevron-down');
        chevron.classList.add('fa-chevron-up');
      } else {
        layerPanel.classList.add('hidden');
        chevron.classList.remove('fa-chevron-up');
        chevron.classList.add('fa-chevron-down');
      }
    });

    // Función para mostrar/ocultar el panel de filtros
    document.getElementById('filter-toggle').addEventListener('click', function() {
      const filterPanel = document.getElementById('filter-panel');
      if (filterPanel.style.display === 'none') {
        filterPanel.style.display = 'block';
      } else {
        filterPanel.style.display = 'none';
      }
    });

    // Event listener para cerrar el panel de filtros
    document.getElementById('close-filters').addEventListener('click', function() {
      document.getElementById('filter-panel').style.display = 'none';
    });

    // Función opcional para asignar colores según el área
    function getColorBasedOnArea(area) {
      // Ajusta estos valores según tus datos
      if (area > 10000) return '#800026';
      if (area > 5000) return '#BD0026';
      if (area > 2000) return '#E31A1C';
      if (area > 1000) return '#FC4E2A';
      return '#FFEDA0';
    }

    // Función para actualizar el mapa con un trimestre específico
    function updateMap(yearqtr) {
      // Filtrar características
      const filteredFeatures = geojsonData.features.filter(f => f.properties.yearqtr === yearqtr);
      
      // Remover capa anterior
      if (filteredLayer) {
        map.removeLayer(filteredLayer);
      }
      
      // Agregar nueva capa
      filteredLayer = L.geoJSON({ type: 'FeatureCollection', features: filteredFeatures }, {
        style: function(feature) {
          return { 
            color: 'red', 
            weight: 2, 
            fillOpacity: 0.5,
            fillColor: getColorBasedOnArea(feature.properties.area)
          };
        },
        onEachFeature: function(feature, layer) {
          if (feature.properties) {
            layer.bindPopup(Object.keys(feature.properties).map(key => {
              return `<b>${key}:</b> ${feature.properties[key]}`;
            }).join('<br />'));
          }
        }
      }).addTo(map);
    }

    // Mostrar modal de bienvenida al cargar la página
    document.addEventListener('DOMContentLoaded', function() {
      const modal = document.getElementById('welcome-modal');
      const closeButton = document.getElementById('close-modal');
      const acceptButton = document.getElementById('accept-modal');
      const showAtStartupCheckbox = document.getElementById('welcome-show-at-startup');
      const toggleBg = document.querySelector('.toggle-bg');
      const toggleDot = document.querySelector('.toggle-dot');
      
      // Cargar preferencia del usuario
      let showWelcome = localStorage.getItem('showWelcome');
      if (showWelcome === null) {
        showWelcome = true;
        localStorage.setItem('showWelcome', 'true');
      } else {
        showWelcome = showWelcome === 'true';
      }
      
      // Configurar estado inicial del interruptor
      showAtStartupCheckbox.checked = showWelcome;
      if (showWelcome) {
        toggleBg.classList.add('bg-teal-500');
        toggleDot.classList.add('transform', 'translate-x-4');
      } else {
        toggleBg.classList.add('bg-gray-300');
      }
      
      // Mostrar modal solo si está activado
      if (showWelcome) {
        setTimeout(() => {
          modal.classList.remove('hidden');
        }, 1000);
      }
      
      // Configurar evento de cierre
      function closeModal() {
        modal.classList.add('hidden');
        localStorage.setItem('showWelcome', showAtStartupCheckbox.checked.toString());
      }
      
      closeButton.addEventListener('click', closeModal);
      acceptButton.addEventListener('click', closeModal);
      
      // Cerrar modal al hacer clic fuera del contenido
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          closeModal();
        }
      });
      
      // Configurar interruptor
      showAtStartupCheckbox.addEventListener('change', function() {
        if (this.checked) {
          toggleBg.classList.remove('bg-gray-300');
          toggleBg.classList.add('bg-teal-500');
          toggleDot.classList.add('transform', 'translate-x-4');
        } else {
          toggleBg.classList.remove('bg-teal-500');
          toggleBg.classList.add('bg-gray-300');
          toggleDot.classList.remove('transform', 'translate-x-4');
        }
      });
    });
  </script>
</body>
</html>